# Dockerfile específico para Rasa
FROM python:3.10-slim

# Instalar dependencias del sistema
RUN apt-get update && apt-get install -y \
    tesseract-ocr \
    tesseract-ocr-spa \
    libgl1-mesa-dri \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    libgthread-2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Crear usuario no-root
RUN groupadd -r rasauser && useradd -r -g rasauser rasauser

# Establecer directorio de trabajo
WORKDIR /app

# Copiar requirements específicos para Rasa
COPY requirements.rasa.txt .

# Instalar dependencias de Python
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir --upgrade certifi && \
    pip install --no-cache-dir -r requirements.rasa.txt

# Copiar código de Rasa
COPY rasa_bot/ ./rasa_bot/

# Usar configuración MÍNIMA (solo puente a LLM)
RUN cp rasa_bot/config.minimal.yml rasa_bot/config.yml && \
    cp rasa_bot/domain.minimal.yml rasa_bot/domain.yml && \
    cp rasa_bot/data/nlu.minimal.yml rasa_bot/data/nlu.yml && \
    cp rasa_bot/data/stories.minimal.yml rasa_bot/data/stories.yml && \
    cp rasa_bot/actions.simple.py rasa_bot/actions.py

# Copiar archivos de configuración a la raíz para Rasa
RUN cp rasa_bot/config.yml . && \
    cp rasa_bot/domain.yml . && \
    cp -r rasa_bot/data . && \
    cp rasa_bot/actions.py .

# Entrenar modelo simple
RUN rasa train

# Cambiar propietario
RUN chown -R rasauser:rasauser /app
USER rasauser

# Exponer puerto
EXPOSE 5005

# Comando para iniciar Rasa
CMD ["python", "-m", "rasa", "run", "--enable-api", "--cors", "*", "--port", "5005"]
